(function(){var h=YAHOO.util.Dom;var e=Alfresco.util.encodeHTML;Alfresco.module.DoclibPermissionsBasic=function(n){Alfresco.module.DoclibPermissionsBasic.superclass.constructor.call(this,"Alfresco.module.DoclibPermissionsBasic",n,["button","container","connection","json"]);this.rolePickers={};return this};YAHOO.extend(Alfresco.module.DoclibPermissionsBasic,Alfresco.component.Base,{options:{siteId:"",roles:null,groups:null,files:null,width:"44em"},containerDiv:null,showDialog:function f(){if(!this.modules.actions){this.modules.actions=new Alfresco.module.DoclibActions()}if(!this.containerDiv){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/permissions-basic",dataObj:{htmlid:this.id,site:this.options.siteId},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load Document Library Permissions template",execScripts:true})}else{this._showDialog()}},onTemplateLoaded:function c(n){this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=n.serverResponse.responseText;var o=h.getFirstChild(this.containerDiv);while(o&&o.tagName.toLowerCase()!="div"){o=h.getNextSibling(o)}this.widgets.dialog=Alfresco.util.createYUIPanel(o,{width:this.options.width});this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",this.onOK);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);var p=this.id+"-permission";this.widgets.rolePicker=new YAHOO.widget.Button(p,{type:"menu",menu:p+"-select"});this.widgets.rolePicker.getMenu().subscribe("click",this.onRoleSelected,this.widgets.rolePicker);this.widgets.resetAll=Alfresco.util.createYUIButton(this,"reset-all",this.onResetAll);this._showDialog()},onRoleSelected:function m(o,n,p){var q=n[1];p.set("label",q.cfg.getProperty("text"));p.set("name",q.value)},onResetAll:function b(n,o){this._applyPermissions("reset-all")},onOK:function i(o,p){var n=this._parseUI();this._applyPermissions("set",n)},_applyPermissions:function d(q,t){var o,w=[];o=this.options.files;for(var s=0,r=o.length;s<r;s++){w.push(o[s].nodeRef)}var v=function u(A){var x;var B=A.json.successCount;var C=A.json.failureCount;this._hideDialog();if(!A.json.overallSuccess){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.failure")});return}YAHOO.Bubbling.fire("filesPermissionsUpdated",{successCount:B,failureCount:C});for(var z=0,y=A.json.totalResults;z<y;z++){x=A.json.results[z];if(x.success){YAHOO.Bubbling.fire(x.type=="folder"?"folderPermissionsUpdated":"filePermissionsUpdated",{multiple:true,nodeRef:x.nodeRef})}}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.success",B)})};var p=function n(x){this._hideDialog();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.failure")})};this.modules.actions.genericAction({success:{callback:{fn:v,scope:this}},failure:{callback:{fn:p,scope:this}},webscript:{method:Alfresco.util.Ajax.POST,name:"permissions/{operation}/site/{site}",params:{site:this.options.siteId,operation:q}},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{nodeRefs:w,permissions:t}}});this.widgets.okButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true)},onCancel:function a(n,o){this._hideDialog()},_showDialog:function g(){var q,p;this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);var s=h.get(this.id+"-title");if(YAHOO.lang.isArray(this.options.files)){s.innerHTML=this.msg("title.multi",this.options.files.length)}else{var n='<span class="light">'+e(this.options.files.displayName)+"</span>";s.innerHTML=this.msg("title.single",n);this.options.files=[this.options.files]}if(this.widgets.rolePicker){this.widgets.rolePicker.set("name","");this.widgets.rolePicker.set("label",this.msg("role.None"))}if(this.widgets.rolePicker){var t=this.options.files[0].permissions.roles;var r;for(q=0,p=t.length;q<p;q++){r=t[q].split(";");if(/SiteCollaborator$/.test(r[1])&&(r[2] in this.options.roles)){this.widgets.rolePicker.set("name",r[2]);this.widgets.rolePicker.set("label",this.msg("role."+r[2]))}}}var o=new YAHOO.util.KeyListener(document,{keys:YAHOO.util.KeyListener.KEY.ESCAPE},{fn:function(v,u){this.onCancel()},scope:this,correctScope:true});o.enable();this.widgets.dialog.show()},_hideDialog:function j(){var n=h.get(this.id+"-form");Alfresco.util.undoCaretFix(n);this.widgets.dialog.hide()},_parseUI:function k(){var o=[],p;p=this.widgets.rolePicker.get("name");if(p){for(var n in this.options.groups){if(n=="EVERYONE"){continue}if((p!="")&&(p!="None")){o.push({group:this.options.groups[n],role:p})}}}return o}});var l=new Alfresco.module.DoclibPermissionsBasic("null")})();